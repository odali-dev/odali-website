<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>odali ‚Äì Mesazhe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --accent: #915eff;
      --accent-soft: rgba(145, 94, 255, 0.15);
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
    }

    .odali-logo-link {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 9999;
    }

    .odali-logo {
    width: 120px;
    height: auto;
    cursor: pointer;
    transition: transform 0.15s ease;
    }

    .odali-logo:hover {
    transform: scale(1.05);
    }


    * {
      box-sizing: border-box;
    }

    body {
    
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, var(--bg) 55%);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 0.75rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, #020617, #020617e0);
      backdrop-filter: blur(10px);
    }

    header .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    header .logo img {
      height: 32px;
      width: 32px;
      border-radius: 999px;
      object-fit: contain;
      background: #111827;
    }

    header .logo span {
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.85rem;
      color: var(--muted);
    }

    header .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.85rem;
      color: var(--muted);
    }

    header button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      padding: 0.25rem 0.9rem;
      cursor: pointer;
      font-size: 0.8rem;
    }

    header button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .app {
      display: flex;
      flex: 1;
      min-height: 0; /* wichtig f√ºr flex+overflow */
    }

    /* Sidebar / Kontakte */

    .sidebar {
      width: 260px;
      max-width: 100%;
      border-right: 1px solid var(--border);
      background: radial-gradient(circle at top left, #111827 0, var(--bg-alt) 55%);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .sidebar-header {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .sidebar-header p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .search {
      position: relative;
      margin-top: 0.5rem;
    }

    .search input {
      width: 100%;
      padding: 0.45rem 0.7rem;
      padding-left: 2rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 0.8rem;
      outline: none;
    }

    .search span {
      position: absolute;
      left: 0.6rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--muted);
    }

    .contacts {
      margin-top: 0.75rem;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      border-radius: 0.75rem;
      background: rgba(15, 23, 42, 0.7);
      padding: 0.25rem;
    }

    .contact {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.4rem 0.55rem;
      border-radius: 0.6rem;
      cursor: pointer;
      transition: background 0.12s ease, transform 0.08s ease;
    }

    .contact:hover {
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .contact.active {
      background: var(--accent-soft);
      outline: 1px solid rgba(145, 94, 255, 0.9);
    }

    .contact-avatar {
      height: 26px;
      width: 26px;
      border-radius: 999px;
      background: radial-gradient(circle, #4b5563, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .contact-main {
      flex: 1;
      min-width: 0;
    }

    .contact-name {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-last {
      font-size: 0.7rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-meta {
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .unread {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.1rem;
      padding: 0 0.25rem;
      height: 1.1rem;
      border-radius: 999px;
      background: var(--accent);
      font-size: 0.7rem;
      color: white;
    }

    /* Chat-Bereich */

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .chat-header {
      padding: 0.9rem 1.3rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(8px);
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .chat-header-left .contact-avatar {
      height: 30px;
      width: 30px;
    }

    .chat-header-main {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .chat-header-main strong {
      font-size: 0.95rem;
    }

    .chat-header-main span {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .chat-header-right {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .chat-body {
      flex: 1;
      padding: 0.9rem 1.3rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      background: radial-gradient(circle at top left, #020617 0, #020617 50%, #020617 100%);
    }

    .message-row {
      display: flex;
      margin-bottom: 0.1rem;
    }

    .message-row.me {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 70%;
      border-radius: 0.9rem;
      padding: 0.45rem 0.7rem;
      font-size: 0.85rem;
      line-height: 1.35;
      position: relative;
      backdrop-filter: blur(2px);
    }

    .message-row.me .message-bubble {
      background: linear-gradient(135deg, var(--accent), #6366f1);
      border-bottom-right-radius: 0.2rem;
      color: white;
    }

    .message-row.them .message-bubble {
      background: rgba(15, 23, 42, 0.95);
      border-bottom-left-radius: 0.2rem;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    .message-meta {
      margin-top: 0.1rem;
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
    }

    .system-message {
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
      margin: 0.4rem 0;
    }

    .chat-footer {
      padding: 0.7rem 1.3rem 0.9rem;
      border-top: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .chat-footer-row {
      display: flex;
      gap: 0.55rem;
      align-items: flex-end;
    }

    .chat-footer textarea {
      flex: 1;
      resize: none;
      min-height: 2.4rem;
      max-height: 5rem;
      border-radius: 0.9rem;
      border: 1px solid var(--border);
      padding: 0.45rem 0.7rem;
      font-size: 0.85rem;
      background: #020617;
      color: var(--text);
      outline: none;
    }

    .chat-footer button {
      border-radius: 999px;
      border: none;
      padding: 0.55rem 1.1rem;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      background: var(--accent);
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .chat-footer button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .chat-footer button span.icon {
      font-size: 1rem;
      margin-bottom: -1px;
    }

    .status-line {
      font-size: 0.75rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
    }

    .status-line span.error {
      color: var(--danger);
    }

    .status-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #10b981;
      margin-right: 0.3rem;
    }

    .status-dot.offline {
      background: #6b7280;
    }

    /* Mobile */

    @media (max-width: 768px) {
      .app {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .chat-header {
        padding-inline: 0.9rem;
      }

      .chat-body,
      .chat-footer {
        padding-inline: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="odali-logo-link">
    <img src="logo_proto_odali.png" alt="odali logo" class="odali-logo">
    </a>

    <div class="logo">
      <!-- ggf. dein Logo einbinden -->
      <!-- <img src="logo_proto_odali2.png" alt="odali" /> -->
      <span>odali ‚Ä¢ mesazhe</span>
    </div>
    <div class="user-info">
      <span id="currentUserLabel">‚Ä¶</span>
      <button type="button" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Kontakte</h2>
        <p>W√§hle einen Kontakt, um zu chatten.</p>
        <div class="search">
          <span>üîç</span>
          <input
            type="text"
            id="searchInput"
            placeholder="Kontakt suchen‚Ä¶"
            autocomplete="off"
          />
        </div>
      </div>
      <div class="contacts" id="contactList">
        <!-- Kontakte werden per JS geladen -->
      </div>
    </aside>

    <main class="chat">
      <div class="chat-header" id="chatHeader">
        <div class="chat-header-left">
          <div class="contact-avatar" id="chatContactAvatar">?</div>
          <div class="chat-header-main">
            <strong id="chatContactName">Kein Kontakt ausgew√§hlt</strong>
            <span id="chatContactStatus">W√§hle links einen Kontakt aus</span>
          </div>
        </div>
        <div class="chat-header-right" id="chatHeaderRight">
          <span id="messageCount">0 Nachrichten</span>
        </div>
      </div>

      <div class="chat-body" id="messages">
        <div class="system-message">
          Kein Chat ausgew√§hlt. W√§hle links einen Kontakt aus oder warte, bis
          die Kontakte geladen sind.
        </div>
      </div>

      <div class="chat-footer">
        <div class="chat-footer-row">
          <textarea
            id="messageInput"
            placeholder="Nachricht schreiben‚Ä¶ (Enter = senden, Shift+Enter = neue Zeile)"
          ></textarea>
          <button id="sendBtn" disabled>
            <span class="icon">‚û§</span>
            Senden
          </button>
        </div>
        <div class="status-line">
          <span>
            <span class="status-dot" id="connectionDot"></span>
            <span id="connectionStatus">Verbinde zum Server‚Ä¶</span>
          </span>
          <span class="error" id="errorStatus"></span>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ==========================
    // KONFIGURATION
    // ==========================
    //
    // URL zu deinem odali-token-server (Render o.√Ñ.)
    const API_BASE = 'https://odali-token-server.onrender.com';
    // Wenn dein Service anders hei√üt, HIER anpassen.

    // Wie du im Frontend speicherst:
    // in login.html nach erfolgreichem Login z.B.:
    //   localStorage.setItem('odali_username', username);
    //   localStorage.setItem('odali_token',    username); // Token = username
    const TOKEN_KEY = 'odali_token';
    const USERNAME_KEY = 'odali_username';

    const POLL_INTERVAL_MS = 3000; // alle 3 Sekunden neue Nachrichten ziehen

    // ==========================
    // STATE
    // ==========================
    let currentUser = null;
    let authToken = null;
    let contacts = [];
    let filteredContacts = [];
    let currentContactId = null;
    let messages = [];
    let pollTimer = null;

    // ==========================
    // DOM ELEMENTE
    // ==========================
    const currentUserLabel = document.getElementById('currentUserLabel');
    const logoutBtn = document.getElementById('logoutBtn');
    const contactListEl = document.getElementById('contactList');
    const chatContactNameEl = document.getElementById('chatContactName');
    const chatContactStatusEl = document.getElementById('chatContactStatus');
    const chatContactAvatarEl = document.getElementById('chatContactAvatar');
    const messageCountEl = document.getElementById('messageCount');
    const messagesEl = document.getElementById('messages');
    const messageInputEl = document.getElementById('messageInput');
    const sendBtnEl = document.getElementById('sendBtn');
    const connectionDotEl = document.getElementById('connectionDot');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const errorStatusEl = document.getElementById('errorStatus');
    const searchInputEl = document.getElementById('searchInput');

    // ==========================
    // HILFSFUNKTIONEN
    // ==========================

    function setConnectionState(state, text) {
      // state: 'connecting' | 'online' | 'offline' | 'error'
      if (state === 'online') {
        connectionDotEl.classList.remove('offline');
        connectionDotEl.style.background = '#10b981';
      } else if (state === 'connecting') {
        connectionDotEl.classList.remove('offline');
        connectionDotEl.style.background = '#eab308';
      } else {
        connectionDotEl.classList.add('offline');
        connectionDotEl.style.background = '#6b7280';
      }
      connectionStatusEl.textContent = text;
    }

    function setError(msg) {
      errorStatusEl.textContent = msg || '';
    }

    function formatTime(dateStringOrMs) {
      const d =
        typeof dateStringOrMs === 'number'
          ? new Date(dateStringOrMs)
          : new Date(dateStringOrMs);
      if (Number.isNaN(d.getTime())) return '';
      return (
        d.getHours().toString().padStart(2, '0') +
        ':' +
        d.getMinutes().toString().padStart(2, '0')
      );
    }

    function formatDateTime(dateStringOrMs) {
      const d =
        typeof dateStringOrMs === 'number'
          ? new Date(dateStringOrMs)
          : new Date(dateStringOrMs);
      if (Number.isNaN(d.getTime())) return '';
      return (
        d.toLocaleDateString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: '2-digit',
        }) +
        ' ‚Ä¢ ' +
        d.toLocaleTimeString('de-DE', {
          hour: '2-digit',
          minute: '2-digit',
        })
      );
    }

    function initials(name) {
      if (!name) return '?';
      return name
        .split(' ')
        .map((p) => p[0]?.toUpperCase())
        .filter(Boolean)
        .join('')
        .slice(0, 2);
    }

    function authHeaders() {
      return {
        'Content-Type': 'application/json',
        Authorization: 'Bearer ' + authToken,
      };
    }

    function scrollMessagesToBottom() {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    // ==========================
    // UI RENDERING
    // ==========================

    function renderContacts() {
      contactListEl.innerHTML = '';
      if (!filteredContacts.length) {
        const div = document.createElement('div');
        div.className = 'system-message';
        div.textContent = 'Keine Kontakte gefunden.';
        contactListEl.appendChild(div);
        return;
      }

      filteredContacts.forEach((c) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'contact';
        wrapper.dataset.id = c.id;
        if (c.id === currentContactId) {
          wrapper.classList.add('active');
        }

        const avatar = document.createElement('div');
        avatar.className = 'contact-avatar';
        avatar.textContent = initials(c.displayName || c.id);

        const main = document.createElement('div');
        main.className = 'contact-main';

        const name = document.createElement('div');
        name.className = 'contact-name';
        name.textContent = c.displayName || c.id;

        const last = document.createElement('div');
        last.className = 'contact-last';
        last.textContent = c.lastMessagePreview || 'Noch kein Chat';

        main.appendChild(name);
        main.appendChild(last);

        const meta = document.createElement('div');
        meta.className = 'contact-meta';

        const time = document.createElement('span');
        time.textContent = c.lastMessageAt
          ? formatTime(c.lastMessageAt)
          : '';

        const unread = document.createElement('span');
        if (c.unreadCount && c.unreadCount > 0) {
          unread.className = 'unread';
          unread.textContent = c.unreadCount;
        }

        meta.appendChild(time);
        if (unread.textContent) meta.appendChild(unread);

        wrapper.appendChild(avatar);
        wrapper.appendChild(main);
        wrapper.appendChild(meta);

        wrapper.addEventListener('click', () => selectContact(c.id));
        contactListEl.appendChild(wrapper);
      });
    }

    function renderMessages() {
      messagesEl.innerHTML = '';

      if (!currentContactId) {
        const div = document.createElement('div');
        div.className = 'system-message';
        div.textContent =
          'Kein Kontakt ausgew√§hlt. W√§hle links einen Kontakt aus.';
        messagesEl.appendChild(div);
        return;
      }

      if (!messages.length) {
        const div = document.createElement('div');
        div.className = 'system-message';
        div.textContent =
          'Noch keine Nachrichten. Schreibe die erste Nachricht!';
        messagesEl.appendChild(div);
        return;
      }

      messages.forEach((m) => {
        const row = document.createElement('div');
        row.className =
          'message-row ' + (m.from === currentUser ? 'me' : 'them');

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';

        const text = document.createElement('div');
        text.textContent = m.text || '';

        const meta = document.createElement('div');
        meta.className = 'message-meta';
        meta.textContent = formatDateTime(m.createdAt || m.timestamp);

        bubble.appendChild(text);
        bubble.appendChild(meta);
        row.appendChild(bubble);
        messagesEl.appendChild(row);
      });

      messageCountEl.textContent =
        messages.length + (messages.length === 1 ? ' Nachricht' : ' Nachrichten');

      scrollMessagesToBottom();
    }

    function updateChatHeader() {
      if (!currentContactId) {
        chatContactNameEl.textContent = 'Kein Kontakt ausgew√§hlt';
        chatContactStatusEl.textContent = 'W√§hle links einen Kontakt aus';
        chatContactAvatarEl.textContent = '?';
        return;
      }
      const c = contacts.find((x) => x.id === currentContactId);
      const displayName = c?.displayName || c?.id || currentContactId;
      chatContactNameEl.textContent = displayName;
      chatContactStatusEl.textContent = 'Nachrichten der letzten 1‚Äì2 Tage (Freunde)';
      chatContactAvatarEl.textContent = initials(displayName);
    }

    function updateSendButtonState() {
      const hasContact = !!currentContactId;
      const hasText = !!messageInputEl.value.trim();
      sendBtnEl.disabled = !(hasContact && hasText);
    }

    // ==========================
    // API CALLS
    // ==========================

    async function fetchJson(url, options = {}) {
      try {
        setError('');
        const res = await fetch(url, options);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || res.statusText);
        }
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) {
          return await res.json();
        }
        return null;
      } catch (err) {
        console.error(err);
        setConnectionState('error', 'Fehler beim Laden');
        setError(err.message);
        throw err;
      }
    }

    async function loadContacts() {
      setConnectionState('connecting', 'Lade Kontakte‚Ä¶');

      // Backend: GET /api/contacts
      try {
        const data = await fetchJson(API_BASE + '/api/contacts', {
          headers: authHeaders(),
        });

        contacts = Array.isArray(data) ? data : [];
      } catch (e) {
        // Wenn Endpoint fehlschl√§gt, zeigen wir eine Info
        contacts = [];
        setError('Konnte Kontakte nicht laden (API /api/contacts).');
      }

      filteredContacts = contacts;
      renderContacts();
      setConnectionState('online', 'Verbunden');
    }

    async function loadMessages() {
      if (!currentContactId) return;

      // Backend: GET /api/messages/:contactId
      try {
        const data = await fetchJson(
          API_BASE + '/api/messages/' + encodeURIComponent(currentContactId),
          {
            headers: authHeaders(),
          }
        );

        messages = Array.isArray(data) ? data : [];
        renderMessages();
        setConnectionState('online', 'Verbunden');
      } catch (err) {
        // z.B. wenn keine Freundschaft: Server gibt 403
        setError('Konnte Nachrichten nicht laden (evtl. kein Freund?).');
      }
    }

    async function sendMessage() {
      if (!currentContactId) return;
      const text = messageInputEl.value.trim();
      if (!text) return;

      sendBtnEl.disabled = true;

      // Backend: POST /api/messages  { to, text }
      try {
        await fetchJson(API_BASE + '/api/messages', {
          method: 'POST',
          headers: authHeaders(),
          body: JSON.stringify({
            to: currentContactId,
            text,
          }),
        });

        messageInputEl.value = '';
        updateSendButtonState();
        await loadMessages();
        setConnectionState('online', 'Verbunden');
      } catch (err) {
        // Fehlertext wird schon in fetchJson gesetzt
      } finally {
        updateSendButtonState();
      }
    }

    // ==========================
    // INTERAKTION
    // ==========================

    function selectContact(contactId) {
      if (contactId === currentContactId) return;
      currentContactId = contactId;
      renderContacts();
      updateChatHeader();
      loadMessages();
      updateSendButtonState();
    }

    function applyContactFilter() {
      const q = searchInputEl.value.trim().toLowerCase();
      if (!q) {
        filteredContacts = contacts;
      } else {
        filteredContacts = contacts.filter((c) => {
          const name = (c.displayName || c.id || '').toLowerCase();
          return name.includes(q);
        });
      }
      renderContacts();
    }

    function setupPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(() => {
        if (currentContactId) {
          loadMessages();
        }
      }, POLL_INTERVAL_MS);
    }

    // ==========================
    // INIT / AUTH
    // ==========================

    function initAuth() {
      authToken = localStorage.getItem(TOKEN_KEY);
      currentUser = localStorage.getItem(USERNAME_KEY);

      if (!authToken || !currentUser) {
        // Nicht eingeloggt
        currentUserLabel.textContent = "S'jeni t√´ ky√ßur";
        chatContactNameEl.textContent = 'Kein Kontakt ausgew√§hlt';
        chatContactStatusEl.textContent = 'Ju lutem t√´ ky√ßeni s√´ pari (Login-Button oben rechts).';
        chatContactAvatarEl.textContent = '?';

        messagesEl.innerHTML = `
          <div class="system-message">
            Ju lutem t√´ ky√ßeni s√´ pari.
          </div>
        `;

        // Chat-Eingabe deaktivieren
        messageInputEl.disabled = true;
        sendBtnEl.disabled = true;

        // Button oben als "Login" verwenden
        logoutBtn.textContent = 'Login';
        logoutBtn.dataset.mode = 'login';

        setConnectionState('offline', 'Nicht eingeloggt');
        return false;
      }

      // Eingeloggt
      currentUserLabel.textContent = currentUser;
      messageInputEl.disabled = false;
      logoutBtn.textContent = 'Logout';
      logoutBtn.dataset.mode = 'logout';
      return true;
    }

    function initEvents() {
      logoutBtn.addEventListener('click', () => {
        // je nach Modus: Login oder Logout
        if (logoutBtn.dataset.mode === 'login') {
          window.location.href = 'login.html?redirect=mesazhe.html';
        } else {
          localStorage.removeItem(TOKEN_KEY);
          localStorage.removeItem(USERNAME_KEY);
          // Nach Logout zur Login-Seite
          window.location.href = 'login.html';
        }
      });

      sendBtnEl.addEventListener('click', () => {
        sendMessage();
      });

      messageInputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      messageInputEl.addEventListener('input', updateSendButtonState);
      searchInputEl.addEventListener('input', applyContactFilter);
    }

    async function init() {
      initEvents();                // Events immer registrieren
      const loggedIn = initAuth(); // pr√ºft Auth + UI-Anpassung

      if (!loggedIn) {
        // Nicht eingeloggt: keine API-Calls, kein Polling
        renderMessages();
        return;
      }

      // Eingeloggt ‚Üí normal weiter
      setConnectionState('connecting', 'Verbinde zum Server‚Ä¶');
      await loadContacts();
      renderMessages();
      setupPolling();
    }

    // Start
    init();
  </script>
</body>
</html>
